"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[319],{319:(R,x,s)=>{s.r(x),s.d(x,{ChatPageModule:()=>k});var u=s(6895),h=s(433),r=s(8408),v=s(7551),a=s(7582),w=s(7825),m=s(3099),d=s(2340),t=s(8274),C=s(7942),y=s(529),b=s(8672),T=s(5730),M=s(51);const S=["chatMessage"],I=["msgInput"];function U(o,g){if(1&o&&(t.TgZ(0,"div",20),t._uU(1),t._UZ(2,"br"),t.TgZ(3,"div",21),t._uU(4),t.ALo(5,"date"),t.qZA()()),2&o){const i=t.oxw().index,n=t.oxw();t.xp6(1),t.hij(" ",n.msg[i].message," "),t.xp6(3),t.Oqu(t.xi3(5,2,n.msg[i].msgTime,"MMM d, yyyy h:mm a"))}}function P(o,g){if(1&o&&(t.TgZ(0,"div",22),t._uU(1),t._UZ(2,"br"),t.TgZ(3,"div",21),t._uU(4),t.ALo(5,"date"),t.qZA()()),2&o){const i=t.oxw().index,n=t.oxw();t.xp6(1),t.hij(" ",n.msg[i].message," "),t.xp6(3),t.Oqu(t.xi3(5,2,n.msg[i].msgTime,"MMM d, yyyy h:mm a"))}}function A(o,g){if(1&o&&(t.TgZ(0,"div",17),t.YNc(1,U,6,5,"div",18),t.YNc(2,P,6,5,"div",19),t._UZ(3,"br"),t.qZA()),2&o){const i=g.index,n=t.oxw();t.xp6(1),t.Q6J("ngIf",n.whoseMessage(n.msg[i].sender,n.msg[i].message)),t.xp6(1),t.Q6J("ngIf",!n.whoseMessage(n.msg[i].sender,n.msg[i].message))}}const B=[{path:"",component:(()=>{class o{constructor(i,n,e,l,c,Z,N,G){var p,f;this.router=i,this.ionLoaderService=n,this.http=e,this.weavyTokenService=l,this.alertService=c,this.elementRef=Z,this.cookieService=N,this.navController=G,this.weavyUserId=-1,this.weavyUid="",this.msgForm=new h.cw({msgInput:new h.NI("")}),this.msg=[],this.roomId=-1,this.displayName="",this.loggedinUserId=-1,this.typing=!1,this.top=100,this.skip=0,this.refMsgCountFromPrevAPICall=0,this.scrollToBottomFlag=!1,this.weavyUserId=null===(p=this.router.getCurrentNavigation())||void 0===p?void 0:p.extras.state.weavyUserId,this.weavyUid=null===(f=this.router.getCurrentNavigation())||void 0===f?void 0:f.extras.state.weavyUid,this.intervalSubscription=(0,w.F)(1e3).subscribe(E=>{this.getMsgListOfRoom()})}ngOnInit(){null!=this.cookieService.getWeavyAccessToken&&null!=this.cookieService.getWeavyAccessToken&&this.cookieService.getWeavyAccessToken.length>0?this.startWeavyConversation():this.weavyTokenService.getWeavyAccessToken(),this.msg=[],this.loggedinUserId=Number(this.cookieService.getUserId)}goToChatPage(){this.navController.navigateForward("/chat-page",d.N.navOptions)}ngOnDestroy(){this.intervalSubscription.unsubscribe()}onSend(){this.sendMsgToRoom(this.roomId,this.msgForm.value.msgInput)}whoseMessage(i,n){return Number(i)===this.loggedinUserId}startWeavyConversation(){return(0,a.mG)(this,void 0,void 0,function*(){const i=yield this.ionLoaderService.showLoader(),n=this.http.post(`${d.N.chatServerBaseUrlV1}/api/conversations`,{members:[this.weavyUserId]}).pipe((0,m.B)());return n.subscribe({next:e=>(0,a.mG)(this,void 0,void 0,function*(){i.dismiss(),null!=e.created_at?(this.displayName=e.display_name,this.roomId=e.id,this.getMsgListOfRoom()):this.alertService.presentAlert("Error",e)}),error:e=>{i.dismiss(),this.alertService.presentAlert("Error: Something went wrong! ",e)}}),n})}getMsgListOfRoom(){return(0,a.mG)(this,void 0,void 0,function*(){const n=this.http.get(`${d.N.chatServerBaseUrlV1}/api/apps/`+this.roomId+"/messages",{params:{top:this.top,skip:this.skip}}).pipe((0,m.B)());return n.subscribe({next:e=>(0,a.mG)(this,void 0,void 0,function*(){if(null!=e)if(null==e.end||e.end==e.count){if(this.refMsgCountFromPrevAPICall==e.count)return void(this.scrollToBottomFlag=!1);this.scrollToBottomFlag=!0,this.refMsgCountFromPrevAPICall=e.count,this.msg=[];for(let l=0;l<e.data.length;l++){const c=e.data[l];this.msg.push({sender:Number(c.created_by.uid.split("RK-")[1]),message:c.text,msgTime:c.created_at})}this.markAsRead()}else this.skip=e.count>=100?e.count-100:e.count-e.count/2;else this.alertService.presentAlert("Error",e)}),error:e=>{this.alertService.presentAlert("Error: Something went wrong! ",e)}}),n})}ngAfterViewChecked(){this.scrollToBottomFlag&&this.scrollToBottom()}scrollToBottom(){try{this.chatMessageDiv.nativeElement.scrollTop=this.chatMessageDiv.nativeElement.scrollHeight}catch(i){console.log("error while scrolling to bottom ",i)}}sendMsgToRoom(i,n){return(0,a.mG)(this,void 0,void 0,function*(){if(null==n||null==n)return!1;const l=this.http.post(`${d.N.chatServerBaseUrlV1}/api/apps/`+i+"/messages",{text:n}).pipe((0,m.B)());return l.subscribe({next:c=>(0,a.mG)(this,void 0,void 0,function*(){null!=c?(this.msg.push({sender:this.cookieService.getUserId,message:n,msgTime:Date.now()}),this.msgForm.value.msgInput="",this.msgInputRef.nativeElement.value=""):this.alertService.presentAlert("Error",c)}),error:c=>{this.alertService.presentAlert("Error: Something went wrong! ",c)}}),l})}markAsRead(){return(0,a.mG)(this,void 0,void 0,function*(){const n=this.http.put(`${d.N.chatServerBaseUrlV1}/api/conversations/`+this.roomId+"/mark",{}).pipe((0,m.B)());return n.subscribe({next:e=>(0,a.mG)(this,void 0,void 0,function*(){null!=e||this.alertService.presentAlert("Error",e)}),error:e=>{this.alertService.presentAlert("Error: Something went wrong! ",e)}}),n})}setAsDelivered(){return(0,a.mG)(this,void 0,void 0,function*(){const n=this.http.put(`${d.N.chatServerBaseUrlV1}/api/conversations/`+this.roomId+"/delivered",{}).pipe((0,m.B)());return n.subscribe({next:e=>(0,a.mG)(this,void 0,void 0,function*(){null!=e||this.alertService.presentAlert("Error",e)}),error:e=>{this.alertService.presentAlert("Error: Something went wrong! ",e)}}),n})}msgInputOnChange(i){console.log(i),!1===this.typing&&i.length>0?(this.typing=!0,this.indicateTyping()):0==i.length&&(this.typing=!1)}indicateTyping(){return(0,a.mG)(this,void 0,void 0,function*(){const n=this.http.put(`${d.N.chatServerBaseUrlV1}/api/apps/`+this.roomId+"/messages/typing",null).pipe((0,m.B)());return n.subscribe({next:e=>(0,a.mG)(this,void 0,void 0,function*(){}),error:e=>{this.alertService.presentAlert("Error: Something went wrong! ",e)}}),n})}}return o.\u0275fac=function(i){return new(i||o)(t.Y36(v.F0),t.Y36(C.C),t.Y36(y.eN),t.Y36(b.f),t.Y36(T.c),t.Y36(t.SBq),t.Y36(M.R),t.Y36(r.SH))},o.\u0275cmp=t.Xpm({type:o,selectors:[["app-chat"]],viewQuery:function(i,n){if(1&i&&(t.Gf(S,5),t.Gf(I,5)),2&i){let e;t.iGM(e=t.CRH())&&(n.chatMessageDiv=e.first),t.iGM(e=t.CRH())&&(n.msgInputRef=e.first)}},inputs:{weavyUserId:"weavyUserId",weavyUid:"weavyUid"},decls:23,vars:3,consts:[["slot","start"],[3,"scrollEvents"],["content",""],[1,"chatMessage"],["chatMessage",""],["class","message-line-outer-span",4,"ngFor","ngForOf"],[1,"goToBottomBtn",2,"display","none",3,"click"],["name","arrow-down-circle-outline"],[2,"margin-bottom","10px","margin-top","10px","box-shadow","none"],[3,"formGroup"],[1,"input-container"],[1,"input-chat"],["formControlName","msgInput",2,"height","43px","width","100%","padding-left","20px","background-color","transparent","border","2px solid rgb(185, 185, 185)","border-radius","30px",3,"ngModelChange"],["msgInput",""],[1,"send-button"],[3,"click"],["name","send"],[1,"message-line-outer-span"],["class","sent-message-line",4,"ngIf"],["class","received-message-line",4,"ngIf"],[1,"sent-message-line"],[1,"msgTime"],[1,"received-message-line"]],template:function(i,n){1&i&&(t.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),t._UZ(3,"ion-menu-button"),t.qZA(),t.TgZ(4,"ion-title"),t._uU(5,"chat"),t.qZA()()(),t.TgZ(6,"ion-content",1,2)(8,"div",3,4),t.YNc(10,A,4,2,"div",5),t.qZA()(),t.TgZ(11,"ion-button",6),t.NdJ("click",function(){return n.scrollToBottom()}),t._UZ(12,"ion-icon",7),t._uU(13," GO TO BOTTOM\n"),t.qZA(),t.TgZ(14,"ion-footer",8)(15,"form",9)(16,"div",10)(17,"div",11)(18,"input",12,13),t.NdJ("ngModelChange",function(l){return n.msgInputOnChange(l)}),t.qZA()(),t.TgZ(20,"div",14)(21,"ion-fab-button",15),t.NdJ("click",function(){return n.onSend()}),t._UZ(22,"ion-icon",16),t.qZA()()()()()),2&i&&(t.xp6(6),t.Q6J("scrollEvents",!0),t.xp6(4),t.Q6J("ngForOf",n.msg),t.xp6(5),t.Q6J("formGroup",n.msgForm))},dependencies:[u.sg,u.O5,h._Y,h.Fj,h.JJ,h.JL,r.YG,r.Sm,r.W2,r.W4,r.fr,r.Gu,r.gu,r.fG,r.wd,r.sr,h.sg,h.u,u.uU],styles:[".input-container[_ngcontent-%COMP%]{width:100%;display:flex;flex-direction:row}.input-chat[_ngcontent-%COMP%]{border:2px solid rgb(185,185,185);border-radius:30px;height:46px;flex-grow:1;margin-left:15px;margin-right:5px}.send-button[_ngcontent-%COMP%]{flex-basis:60px;width:30px}.chatMessage[_ngcontent-%COMP%]{overflow-y:scroll;scroll-behavior:smooth;height:100%}table[_ngcontent-%COMP%]{width:100%;height:50px}ion-fab-button[_ngcontent-%COMP%]{width:47px;height:47px}.message-line-outer-span[_ngcontent-%COMP%]{width:100%;height:auto;color:#fff;font-size:large;margin-top:5px;padding-right:15px;padding-left:15px}.received-message-line[_ngcontent-%COMP%]{width:-webkit-fit-content;width:-moz-fit-content;width:fit-content;max-width:80%;background-color:#008383;border-radius:20px;padding:8px 15px}.sent-message-line[_ngcontent-%COMP%]{display:block;margin-left:auto;height:-webkit-fit-content;height:-moz-fit-content;height:fit-content;width:-webkit-fit-content;width:-moz-fit-content;width:fit-content;max-width:80%;background-color:#9e29ad;border-radius:20px;padding:8px 15px}.msgTime[_ngcontent-%COMP%]{width:100%;padding-top:5px;text-align:right;font-size:x-small}.goToBottomBtn[_ngcontent-%COMP%]{--background: rgba(0, 0, 0, .219);font-size:x-small;height:20px;width:300px;--border-radius: 50px;position:fixed;z-index:10;bottom:0;width:40%;margin-left:30%;margin-right:30%;margin-bottom:75px}"]}),o})()}];let O=(()=>{class o{}return o.\u0275fac=function(i){return new(i||o)},o.\u0275mod=t.oAB({type:o}),o.\u0275inj=t.cJS({imports:[v.Bz.forChild(B),v.Bz]}),o})(),k=(()=>{class o{}return o.\u0275fac=function(i){return new(i||o)},o.\u0275mod=t.oAB({type:o}),o.\u0275inj=t.cJS({imports:[u.ez,h.u5,r.Pc,O,h.UX]}),o})()}}]);